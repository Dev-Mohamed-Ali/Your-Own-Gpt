<!DOCTYPE html>
<html>
<head>
    <title>ChatGPT - Your AI Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ChatGPT - Your AI Chatbot</h1>
            <i id="dark-mode-toggle" class="fas fa-sun"></i>
        </div>
        <div class="chat-container">
            <div class="chatbox" id="chatbox">
                <!-- Chat messages will be displayed here -->
                <!-- Display chat history here -->
                 {% for sender, message in chat_history %}
                    <p><strong>{{ sender }}:</strong> {{ message }}</p>
                {% endfor %}
            </div>
            <div class="user-input">
                <input type="text" id="user_input" class="form-control" placeholder="Type your message...">
                <button id="send-btn" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
   <script>
       scrollToBottom();
        function showThinkingMessage() {
            $("#chatbox").append(`<p><strong>Bot:</strong> Thinking....</p>`);
            scrollToBottom();
        }

        function toggleDarkMode() {
            $("body").toggleClass("dark-mode");
        }

        function appendMessage(who, message) {
            $("#chatbox").append(`<p><strong>${who}:</strong> ${message}</p>`);
            scrollToBottom();
        }

        function getUserInput() {
            return $("#user_input").val();
        }
        function cleanUserInput(user_input) {
            return user_input.replace(/\?/g, ""); // Remove all question marks
        }
        function handleChatbotResponse(response,temp_user_input) {
            $("#chatbox p:last-child").remove(); // Remove the "Thinking..." message

            if (response.startsWith("Bot: I don't know the answer.")) {
                // If the bot doesn't know the answer, prompt the user to teach the bot
                var new_answer = prompt("Bot: I don't know the answer. Type the answer or 'skip' to skip:");

                if (new_answer && new_answer.trim().toLowerCase() !== 'skip') {
                    // User provided an answer, send it to the server to update the knowledge base
                    $.ajax({
                        type: "POST",
                        url: "/update_knowledge_base",
                        data: JSON.stringify({
                            user_input: temp_user_input,
                            new_answer: new_answer
                        }),
                        contentType: "application/json;charset=UTF-8",
                        success: function (response) {
                            appendMessage("Bot", "Thank you! I've learned something new.");
                            $("#user_input").focus(); // Put focus back on the input field
                        }
                    });
                } else {
                    appendMessage("Bot", "Bot: Alright, I understand. Feel free to ask anything else!");
                    // User skipped teaching, simply clear the input field and continue
                    $("#user_input").focus();
                }
            } else {
                // Regular response from the bot, display it
                appendMessage("Chatbot", response);
                $("#user_input").focus(); // Put focus back on the input field
            }
        }

        function sendMessageToServer() {
            var user_input = getUserInput();
            $("#user_input").val(""); // Clear the user input field
            var currentUser = "{{ session['username'] }}";
            appendMessage(currentUser, user_input);
            // Clean the user input before sending
            var cleaned_input = cleanUserInput(user_input);

            showThinkingMessage();


            $.ajax({
                type: "POST",
                url: "/get_response",
                data: JSON.stringify({ user_input: cleaned_input }),
                contentType: "application/json;charset=UTF-8",
                success: function (response) {
                    handleChatbotResponse(response,cleaned_input);
                }
            });
        }

        function scrollToBottom() {
            $("#chatbox").scrollTop($("#chatbox")[0].scrollHeight);
        }

        $(document).ready(function() {
            $("#user_input").on("keydown", function(event) {
                if (event.key === "Enter") {
                    sendMessageToServer();
                }
            });

            $("#send-btn").on("click", function() {
                sendMessageToServer();
            });

            $("#dark-mode-toggle").on("click", function() {
                toggleDarkMode();
            });
        });
    </script>
</body>
</html>
